app-id: co.aiclient.risu
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node20
command: risuai
separate-locales: false

finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --filesystem=home
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=com.canonical.indicator.application
  - --own-name=org.mpris.MediaPlayer2.risuai

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/node20/bin
  build-args:
    - --share=network
  env:
    CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
    CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=--target=x86_64-unknown-linux-gnu
    CC_x86_64_unknown_linux_gnu: clang --target=x86_64-unknown-linux-gnu
    CXX_x86_64_unknown_linux_gnu: clang++ --target=x86_64-unknown-linux-gnu
    # Node.js와 pnpm 설정
    NODE_ENV: production
    PNPM_HOME: /run/build/risuai/pnpm-global
    PNPM_CONFIG_LOGLEVEL: info
    PNPM_CONFIG_REGISTRY: https://registry.npmjs.org/
    PNPM_CONFIG_STORE_DIR: /run/build/risuai/pnpm-store
    PNPM_CONFIG_CACHE_DIR: /run/build/risuai/pnpm-cache
    PNPM_CONFIG_STATE_DIR: /run/build/risuai/pnpm-state
    PNPM_CONFIG_SHAMEFULLY_HOIST: 'true'
    PNPM_CONFIG_STRICT_PEER_DEPENDENCIES: 'false'
    # 플랫폼 관련 설정
    npm_config_target_platform: linux
    npm_config_target_arch: x64
    npm_config_disturl: https://electronjs.org/headers
    npm_config_force: 'true'
    npm_config_optional: 'false'
    npm_config_legacy_peer_deps: 'true'

modules:
  - name: risuai
    buildsystem: simple
    build-commands:
      # Node.js 및 corepack 설정
      - export PATH=/usr/lib/sdk/node20/bin:$PATH
      - node --version
      - npm --version
      # corepack을 통해 pnpm 활성화
      - corepack enable
      - corepack prepare pnpm@9 --activate
      - pnpm --version
      # 플랫폼별 선택적 의존성 무시하고 pnpm 설치
      - pnpm config set target-platform linux
      - pnpm config set target-arch x64
      - pnpm config set optional false
      - pnpm config set force true
      - pnpm config set legacy-peer-deps true
      - pnpm config set registry https://registry.npmjs.org/
      # 의존성 설치 (플랫폼별 패키지 무시)
      - PNPM_CONFIG_OPTIONAL=false pnpm install --no-frozen-lockfile --force --ignore-platform
      # Tauri 빌드 (Linux x64 타겟 명시)
      - pnpm tauri build -- --target x86_64-unknown-linux-gnu
      # 설치
      - install -Dm755 src-tauri/target/x86_64-unknown-linux-gnu/release/risuai -t /app/bin/
      - install -Dm644 src-tauri/icons/128x128.png /app/share/icons/hicolor/128x128/apps/co.aiclient.risu.png
      - install -Dm644 src-tauri/icons/128x128@2x.png /app/share/icons/hicolor/256x256/apps/co.aiclient.risu.png
      - install -Dm644 co.aiclient.risu.metainfo.xml -t /app/share/metainfo/
      - install -Dm644 co.aiclient.risu.desktop -t /app/share/applications/
    sources:
      - type: dir
        path: .
        skip:
          - .git
          - node_modules
          - src-tauri/target