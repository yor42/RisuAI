name: 'publish'
on:
  push:
    branches:
      - production
  workflow_dispatch: {}

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        # platform: [ubuntu-latest,macos-latest,windows-latest]
        settings:
          - platform: 'macos-latest' # for Arm based macs (M1 and above).
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest' # for Intel based macs.
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-latest' # for Tauri v1 you could replace this with ubuntu-20.04.
            args: '--target x86_64-unknown-linux-gnu'
          - platform: 'ubuntu-22.04' # ARM Linux support (Raspberry Pi, ARM servers, etc.) - using 22.04 to avoid Noble ARM64 repo issues
            args: '--target aarch64-unknown-linux-gnu'
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
          - platform: 'windows-latest'
            args: '--target aarch64-pc-windows-msvc'
          - platform: 'ubuntu-latest' # Android build
            args: 'android'
            android: true
          # iOS build - ê°œë°œì ê³„ì • ì—†ìŒìœ¼ë¡œ ì¸í•´ ì¼ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™”
          # - platform: 'macos-latest' # iOS build
          #   args: 'ios'
          #   ios: true

    runs-on: ${{ matrix.settings.platform }}
    steps:
      - uses: actions/checkout@v4
      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - id: set_var_win
        if: matrix.settings.platform == 'windows-latest'
        run: |
          choco install jq -y
      - id: set_var
        shell: bash
        run: |
          echo "VERSION_JSON=$(jq -c . < version.json)" >> $GITHUB_ENV
          
          # ë²„ì „-ë‚ ì§œ-ì‹œê°„ í˜•íƒœì˜ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„±
          TAURI_VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          BUILD_DATE=$(date +'%Y%m%d')
          BUILD_TIME=$(date +'%H%M%S')
          RELEASE_TAG="${TAURI_VERSION}-${BUILD_DATE}-${BUILD_TIME}"
          
          echo "TAURI_VERSION=$TAURI_VERSION" >> $GITHUB_ENV
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          
          echo "Generated release tag: $RELEASE_TAG"
      - name: install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false
      - name: install dependencies (ubuntu amd64 only)
        if: startsWith(matrix.settings.platform, 'ubuntu') && !matrix.settings.android && !matrix.settings.flatpak && !contains(matrix.settings.args, 'aarch64-unknown-linux-gnu')
        run: |
          # AMD64 ë¹Œë“œìš© ì˜ì¡´ì„± ì„¤ì¹˜
          echo "=== Ubuntu AMD64 Build Environment ==="
          lsb_release -a
          
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
      - name: install dependencies (ubuntu arm64 cross-compilation)
        if: startsWith(matrix.settings.platform, 'ubuntu') && contains(matrix.settings.args, 'aarch64-unknown-linux-gnu')
        run: |
          # ARM64 í¬ë¡œìŠ¤ì»´íŒŒì¼ í™˜ê²½ ì„¤ì •
          echo "=== Ubuntu ARM64 Cross-compilation Environment ==="
          lsb_release -a
          
          # ì €ì¥ì†Œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ (ports.ubuntu.comë§Œ)
          echo "=== Repository Access Test ==="
          UBUNTU_CODENAME=$(lsb_release -cs)
          curl -I http://ports.ubuntu.com/ubuntu-ports/dists/$UBUNTU_CODENAME/main/binary-arm64/Packages || echo "ARM64 ports repo test failed"
          
          # íŒ¨í‚¤ì§€ ì¶©ëŒ ë°©ì§€
          echo "=== Preventing Package Conflicts ==="
          if dpkg -l | grep -q "pkg-config"; then
            echo "Removing existing pkg-config to avoid conflicts..."
            sudo apt-get remove -y pkg-config pkg-config:arm64 || true
            sudo apt-get autoremove -y || true
          fi
          
          # ARM64 ì•„í‚¤í…ì²˜ ì¶”ê°€
          sudo dpkg --add-architecture arm64
          
          # ê¸°ì¡´ ì €ì¥ì†Œë¥¼ AMD64/i386ë¡œ ì œí•œ
          sudo cp /etc/apt/sources.list /etc/apt/sources.list.backup
          sudo sed -i 's/^deb /deb [arch=amd64,i386] /' /etc/apt/sources.list
          sudo sed -i 's/^deb-src /deb-src [arch=amd64,i386] /' /etc/apt/sources.list
          
          # ARM64 ì „ìš© ports ì €ì¥ì†Œ ì¶”ê°€ (security í¬í•¨)
          echo "=== Configuring ARM64 Repositories ==="
          sudo tee /etc/apt/sources.list.d/arm64-ports.list > /dev/null << EOF
          # ARM64 ì „ìš© ports ì €ì¥ì†Œ (security í¬í•¨)
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $UBUNTU_CODENAME main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $UBUNTU_CODENAME-updates main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $UBUNTU_CODENAME-backports main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $UBUNTU_CODENAME-security main restricted universe multiverse
          EOF
          
          echo "ARM64 repository configuration:"
          cat /etc/apt/sources.list.d/arm64-ports.list
          
          # íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
          sudo apt-get update
          
          # ê¸°ë³¸ ì˜ì¡´ì„± ì„¤ì¹˜ (AMD64)
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
          
          # pkgconf ë° jq ì„¤ì¹˜
          sudo apt-get install -y pkgconf jq
          
          # ARM64 ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ë¹Œë“œ ë©”ì‹œì§€ ì¶”ì²œ íŒ¨í‚¤ì§€ í¬í•¨)
          echo "=== Installing ARM64 Libraries ==="
          arm64_packages=(
            "libglib2.0-dev:arm64"
            "libgtk-3-dev:arm64"
            "libgdk-pixbuf-2.0-dev:arm64"
            "libcairo2-dev:arm64"
            "libpango1.0-dev:arm64"
            "libatk1.0-dev:arm64"
            "libwebkit2gtk-4.1-dev:arm64"
            "libappindicator3-dev:arm64"
            "librsvg2-dev:arm64"
          )
          
          # ì •í™•í•œ Ubuntu íŒ¨í‚¤ì§€ëª…ìœ¼ë¡œ GDK 3.0 ì„¤ì¹˜
          echo "=== Installing Correct GDK 3.0 Packages ==="
          # Ubuntuì—ì„œ gdk-3.0.pcëŠ” libgtk-3-devì— í¬í•¨ë¨
          gdk_packages=(
            "libgtk-3-dev:arm64"  # ì´ë¯¸ ìœ„ì—ì„œ ì„¤ì¹˜ë˜ì§€ë§Œ í™•ì‹¤í•˜ê²Œ
          )
          
          # pkg-configì—ì„œ í•„ìš”í•œ ê²½ìš° ì§ì ‘ ê²€ìƒ‰í•˜ì—¬ ì„¤ì¹˜
          echo "Checking for GDK 3.0 in existing packages..."
          if ! pkgconf --exists gdk-3.0 2>/dev/null; then
            echo "GDK 3.0 not found, installing additional packages..."
            additional_gdk_packages=(
              "pkg-config:arm64"
              "pkgconf:arm64"
            )
          else
            echo "GDK 3.0 already available"
          fi
          
          # ê¸°ë³¸ ARM64 íŒ¨í‚¤ì§€ ì„¤ì¹˜
          for package in "${arm64_packages[@]}"; do
            echo "Installing $package..."
            sudo apt-get install -y --no-install-recommends "$package" || {
              echo "Failed to install $package, continuing..."
            }
          done
          
          # ì˜ì¡´ì„± ìƒíƒœ ìµœì¢… í™•ì¸
          echo "=== Final Dependency Status Check ==="
          echo "Installed ARM64 packages:"
          dpkg -l | grep :arm64 | grep -E "(gtk|gdk|cairo|pango)" || echo "No GTK-related ARM64 packages found"
          
          # pkg-config íŒŒì¼ ìƒì„¸ í™•ì¸
          echo "=== Final pkg-config Verification ==="
          echo "Available pkg-config files in ARM64:"
          find /usr/lib/aarch64-linux-gnu/pkgconfig -name "*.pc" 2>/dev/null | head -10 || echo "No pkg-config files found"
          echo "GDK related files:"
          find /usr/lib/aarch64-linux-gnu/pkgconfig -name "*gdk*" 2>/dev/null || echo "No GDK pkg-config files"
          find /usr/lib/aarch64-linux-gnu/pkgconfig -name "*gtk*" 2>/dev/null || echo "No GTK pkg-config files"
          echo "Testing basic pkg-config functionality:"
          pkgconf --exists glib-2.0 && echo "âœ… GLib 2.0 available" || echo "âŒ GLib 2.0 not available"
          pkgconf --exists cairo && echo "âœ… Cairo available" || echo "âŒ Cairo not available"
          pkgconf --exists pango && echo "âœ… Pango available" || echo "âŒ Pango not available"
          pkgconf --exists gdk-3.0 && echo "âœ… GDK 3.0 available" || echo "âŒ GDK 3.0 NOT available (expected if dependencies failed)"
          
          echo "ARM64 cross-compilation environment setup completed"
      - name: setup java (android only)
        if: matrix.settings.android
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: setup android sdk (android only)
        if: matrix.settings.android
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 8512546
          log-accepted-android-sdk-licenses: false
      - name: install android ndk and setup (android only)
        if: matrix.settings.android
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;25.1.8937393"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.1.8937393" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_HOME/ndk/25.1.8937393" >> $GITHUB_ENV
      - name: setup flatpak (Linux builds)
        if: startsWith(matrix.settings.platform, 'ubuntu') && !matrix.settings.android
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          
          # ì•„í‚¤í…ì²˜ ì„¤ì •
          if [[ "${{ matrix.settings.args }}" == *"aarch64-unknown-linux-gnu"* ]]; then
            echo "=== Setting up ARM64 Flatpak build ==="
            FLATPAK_ARCH="aarch64"
            # ARM64ëŠ” AMD64 í™˜ê²½ì—ì„œë§Œ ë¹Œë“œí•˜ë¯€ë¡œ cross-compilation ì ‘ê·¼
            echo "ARM64 Flatpak will be built using cross-compilation on AMD64"
          else
            echo "=== Setting up AMD64 Flatpak build ==="
            FLATPAK_ARCH="x86_64"
          fi
          
          echo "FLATPAK_ARCH=$FLATPAK_ARCH" >> $GITHUB_ENV
          
          # Flathub ì €ì¥ì†Œ ì¶”ê°€
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          
          # ì•„í‚¤í…ì²˜ì— ê´€ê³„ì—†ì´ ê¸°ë³¸ ëŸ°íƒ€ì„ë§Œ ì„¤ì¹˜ (AMD64)
          echo "Installing base Flatpak runtime and SDK..."
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 || echo "Platform installation failed, continuing..."
          sudo flatpak install -y flathub org.freedesktop.Sdk//23.08 || echo "SDK installation failed, continuing..."
          sudo flatpak install -y flathub org.freedesktop.Sdk.Extension.rust-nightly//23.08 || echo "Rust extension installation failed, continuing..."
          sudo flatpak install -y flathub org.freedesktop.Sdk.Extension.node20//23.08 || echo "Node extension installation failed, continuing..."
          
          # ARM64ì˜ ê²½ìš° QEMU ì„¤ì • ì¶”ê°€
          if [[ "$FLATPAK_ARCH" == "aarch64" ]]; then
            echo "=== Setting up QEMU for ARM64 emulation ==="
            sudo apt-get install -y qemu-user-static binfmt-support
            sudo systemctl restart systemd-binfmt || true
          fi
          
          # DNS ì„¤ì • ê°œì„ 
          echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
          echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
      - name: install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        if: ${{ !startsWith(matrix.settings.platform, 'ubuntu') || matrix.settings.android }}
        with:
          targets: ${{ matrix.settings.platform == 'macos-latest' && (matrix.settings.ios && 'aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim' || 'aarch64-apple-darwin,x86_64-apple-darwin') || (matrix.settings.platform == 'windows-latest' && 'aarch64-pc-windows-msvc,x86_64-pc-windows-msvc' || (matrix.settings.android && 'aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android' || '')) }}
      - name: install Rust nightly (Linux builds for Flatpak compatibility)
        uses: dtolnay/rust-toolchain@nightly
        if: startsWith(matrix.settings.platform, 'ubuntu') && !matrix.settings.android
        with:
          targets: ${{ contains(matrix.settings.args, 'aarch64-unknown-linux-gnu') && 'aarch64-unknown-linux-gnu' || 'x86_64-unknown-linux-gnu' }}
      - name: Rust diagnostic
        run: |
          echo "=== Rust Toolchain Diagnostic ==="
          rustc --version
          cargo --version
          rustup show
          echo "=== Dependency Tree Analysis ==="
          cd src-tauri
          cargo tree --format "{p} {f}" | grep -E "(base64ct|edition)" || echo "No edition-related dependencies found"
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          # pnpm store pathê°€ ì‹¤íŒ¨í•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì•ˆì „í•œ ë°©ë²•
          if command -v pnpm >/dev/null 2>&1; then
            STORE_PATH=$(pnpm store path 2>/dev/null || echo "")
            if [ -z "$STORE_PATH" ] || [ ! -d "$STORE_PATH" ]; then
              # ê¸°ë³¸ pnpm store ê²½ë¡œ ì‚¬ìš©
              case "${{ runner.os }}" in
                Windows)
                  STORE_PATH="$HOME/AppData/Local/pnpm/store"
                  ;;
                macOS)
                  STORE_PATH="$HOME/Library/pnpm/store"
                  ;;
                Linux)
                  STORE_PATH="$HOME/.local/share/pnpm/store"
                  ;;
              esac
            fi
          else
            # pnpmì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ê²½ë¡œ ì„¤ì •
            case "${{ runner.os }}" in
              Windows)
                STORE_PATH="$HOME/AppData/Local/pnpm/store"
                ;;
              macOS)
                STORE_PATH="$HOME/Library/pnpm/store"
                ;;
              Linux)
                STORE_PATH="$HOME/.local/share/pnpm/store"
                ;;
            esac
          fi
          echo "STORE_PATH=$STORE_PATH" >> $GITHUB_OUTPUT
          echo "Using pnpm store path: $STORE_PATH"
      - uses: actions/cache@v4
        name: Setup pnpm cache
        continue-on-error: true
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            ${{ runner.os }}-pnpm-
      - name: configure dns and network settings (linux/macos only)
        if: startsWith(matrix.settings.platform, 'ubuntu') || matrix.settings.platform == 'macos-latest'
        run: |
          echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
          echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
          echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf
      - name: install frontend dependencies
        shell: bash
        run: |
          # pnpm ì„¤ì¹˜ í™•ì¸
          if ! command -v pnpm >/dev/null 2>&1; then
            echo "pnpm not found, installing via corepack..."
            corepack enable
            corepack prepare pnpm@latest --activate
          fi
          
          # pnpm ë²„ì „ í™•ì¸
          echo "pnpm version: $(pnpm --version)"
          
          for i in {1..3}; do
            echo "Attempt $i: Installing frontend dependencies..."
            if pnpm install --no-frozen-lockfile; then
              echo "Successfully installed dependencies on attempt $i"
              break
            else
              echo "Attempt $i failed, waiting 30 seconds before retry..."
              sleep 30
              if [ $i -eq 3 ]; then
                echo "All attempts failed, exiting..."
                exit 1
              fi
            fi
          done
      - if: matrix.settings.platform == 'macos-latest'
        run: rustup target add x86_64-apple-darwin
      - if: matrix.settings.platform == 'macos-latest'
        run: rustup target add aarch64-apple-darwin
      - name: add android rust targets
        if: matrix.settings.android
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android
      - name: setup arm linux cross compilation
        if: contains(matrix.settings.args, 'aarch64-unknown-linux-gnu')
        run: |
          rustup target add aarch64-unknown-linux-gnu
          
          # ARM64 í¬ë¡œìŠ¤ ì»´íŒŒì¼ ë„êµ¬ ê°œë³„ ì„¤ì¹˜ (ì˜ì¡´ì„± ë¬¸ì œ í•´ê²°)
          sudo apt-get update
          
          # ê¸°ë³¸ í¬ë¡œìŠ¤ ì»´íŒŒì¼ ë„êµ¬ ì„¤ì¹˜ (pkgconf ì‚¬ìš©)
          echo "Installing ARM64 cross-compilation toolchain..."
          sudo apt-get install -y --no-install-recommends \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            libc6-dev-arm64-cross
          
          # pkgconf í™•ì¸ ë° ì„¤ì¹˜ (ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë©´ ìŠ¤í‚µ)
          if ! command -v pkgconf >/dev/null 2>&1; then
            echo "Installing pkgconf..."
            sudo apt-get install -y pkgconf || {
              echo "pkgconf installation failed, removing conflicting packages..."
              sudo apt-get remove -y pkg-config || true
              sudo apt-get install -y pkgconf
            }
          else
            echo "pkgconf already available"
          fi
          
          # ARM64 ì•„í‚¤í…ì²˜ ì¶”ê°€
          sudo dpkg --add-architecture arm64
          
          # ARM64 íŒ¨í‚¤ì§€ ì €ì¥ì†Œ ì„¤ì •
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $(lsb_release -cs) main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/arm64.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $(lsb_release -cs)-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm64.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $(lsb_release -cs)-backports main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm64.list
          
          # íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ (ì˜¤ë¥˜ ë¬´ì‹œ)
          sudo apt-get update || true
          
          # í•„ìˆ˜ ARM64 ê°œë°œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ì˜¤ë¥˜ ë¬´ì‹œí•˜ê³  ê³„ì†)
          essential_packages=(
            "libglib2.0-dev:arm64"
            "libgtk-3-dev:arm64"
            "libwebkit2gtk-4.1-dev:arm64"
            "libappindicator3-dev:arm64"
            "librsvg2-dev:arm64"
          )
          
          for package in "${essential_packages[@]}"; do
            echo "Attempting to install $package..."
            sudo apt-get install -y --no-install-recommends --fix-broken "$package" || {
              echo "Failed to install $package, trying alternative approach..."
              sudo apt-get install -y --no-install-recommends "$package" --ignore-missing || echo "Skipping $package due to dependency issues"
            }
          done
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++" >> $GITHUB_ENV
          echo "AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar" >> $GITHUB_ENV
          echo "STRIP_aarch64_unknown_linux_gnu=aarch64-linux-gnu-strip" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_SYSTEM_CFLAGS=1" >> $GITHUB_ENV
          echo "PKG_CONFIG_SYSROOT_DIR=/usr/aarch64-linux-gnu/" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
          echo "RUSTFLAGS=-L /usr/lib/aarch64-linux-gnu -L /usr/aarch64-linux-gnu/lib" >> $GITHUB_ENV
          echo "BINDGEN_EXTRA_CLANG_ARGS=-I/usr/aarch64-linux-gnu/include" >> $GITHUB_ENV
          
          # í¬ë¡œìŠ¤ ì»´íŒŒì¼ ë„êµ¬ í™•ì¸
          echo "Cross-compilation tools verification:"
          which aarch64-linux-gnu-gcc && aarch64-linux-gnu-gcc --version || echo "gcc not found"
          which aarch64-linux-gnu-g++ && aarch64-linux-gnu-g++ --version || echo "g++ not found"
          
          # ì˜ì¡´ì„± ë¬¸ì œê°€ ìˆì–´ë„ ë¹Œë“œ ê³„ì† ì§„í–‰
          echo "Cross-compilation environment setup completed with available tools"
      # ARM64 ë¹Œë“œ íŠ¹ìˆ˜ ì²˜ë¦¬ê°€ í•„ìš” ì—†ì–´ì¡Œìœ¼ë¯€ë¡œ ì œê±°ë¨
      # ì´ì œ ëª¨ë“  Linux ì•„í‚¤í…ì²˜ì—ì„œ ë™ì¼í•œ ì„¤ì • ì‚¬ìš©
      # Modified tauri-action step - no longer creates releases
      - uses: tauri-apps/tauri-action@v0.5.16
        if: ${{ !matrix.settings.flatpak && !matrix.settings.android && !matrix.settings.ios }}
        continue-on-error: ${{ contains(matrix.settings.args, 'aarch64-unknown-linux-gnu') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          # ARM64 Linuxì—ì„œëŠ” AppImage í¬ë¡œìŠ¤ì»´íŒŒì¼ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ deb, rpmë§Œ ë¹Œë“œ
          TAURI_BUNDLE_TARGETS: ${{ contains(matrix.settings.args, 'aarch64-unknown-linux-gnu') && 'deb,rpm' || '' }}
          # AppImage ê´€ë ¨ í™˜ê²½ë³€ìˆ˜ ë¹„í™œì„±í™” (ARM64 Linuxì—ì„œë§Œ)
          DISABLE_APPIMAGE: ${{ contains(matrix.settings.args, 'aarch64-unknown-linux-gnu') && '1' || '0' }}
        with:
          # Enable updater JSON generation for Tauri updater functionality
          includeUpdaterJson: true
          args: ${{ matrix.settings.args }}
          tauriScript: "pnpm tauri"
      # Arch Linux íŒ¨í‚¤ì§€ ìƒì„± (Linux ë¹Œë“œì—ì„œë§Œ)
      - name: create arch linux package (.pkg.tar.zst)
        if: startsWith(matrix.settings.platform, 'ubuntu') && !matrix.settings.android && !matrix.settings.ios
        run: |
          echo "=== Creating Arch Linux Package ==="
          
          # ì•„í‚¤í…ì²˜ë³„ ë°”ì´ë„ˆë¦¬ ê²½ë¡œ í™•ì¸
          if [[ "${{ matrix.settings.args }}" == *"aarch64-unknown-linux-gnu"* ]]; then
            TARGET_DIR="src-tauri/target/aarch64-unknown-linux-gnu/release"
            ARCH="aarch64"
          else
            TARGET_DIR="src-tauri/target/x86_64-unknown-linux-gnu/release"
            ARCH="x86_64"
          fi
          
          # ë°”ì´ë„ˆë¦¬ íŒŒì¼ í™•ì¸
          if [ -f "$TARGET_DIR/RisuAI" ]; then
            BINARY_NAME="RisuAI"
          elif [ -f "$TARGET_DIR/risuai" ]; then
            BINARY_NAME="risuai"
          else
            echo "No binary found in $TARGET_DIR, skipping Arch package creation"
            exit 0
          fi
          
          echo "Found binary: $TARGET_DIR/$BINARY_NAME"
          
          # íŒ¨í‚¤ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          TAURI_VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          
          # íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
          PKG_DIR="risuai-arch-$ARCH"
          mkdir -p "$PKG_DIR/usr/bin"
          mkdir -p "$PKG_DIR/usr/share/applications"
          mkdir -p "$PKG_DIR/usr/share/icons/hicolor/128x128/apps"
          
          # ë°”ì´ë„ˆë¦¬ ë³µì‚¬
          cp "$TARGET_DIR/$BINARY_NAME" "$PKG_DIR/usr/bin/risuai"
          chmod +x "$PKG_DIR/usr/bin/risuai"
          
          # ì•„ì´ì½˜ ë³µì‚¬ (ìˆëŠ” ê²½ìš°)
          if [ -f "src-tauri/icons/128x128.png" ]; then
            cp "src-tauri/icons/128x128.png" "$PKG_DIR/usr/share/icons/hicolor/128x128/apps/co.aiclient.risu.png"
          fi
          
          # .desktop íŒŒì¼ ìƒì„±
          cat > "$PKG_DIR/usr/share/applications/co.aiclient.risu.desktop" << EOF
          [Desktop Entry]
          Name=RisuAI
          Comment=AI Chat Application
          Exec=risuai
          Icon=co.aiclient.risu
          Type=Application
          Categories=Network;Chat;
          EOF
          
          # .PKGINFO íŒŒì¼ ìƒì„±
          cat > "$PKG_DIR/.PKGINFO" << EOF
          pkgname = risuai
          pkgver = $TAURI_VERSION-1
          pkgdesc = AI Chat Application
          url = https://github.com/kwaroran/RisuAI
          builddate = $(date +%s)
          packager = GitHub Actions
          size = $(du -sb "$PKG_DIR" | cut -f1)
          arch = $ARCH
          license = MIT
          EOF
          
          # íŒ¨í‚¤ì§€ ìƒì„± (zstd ì••ì¶•)
          cd "$PKG_DIR"
          sudo apt-get update && sudo apt-get install -y zstd
          tar -cf - . | zstd -c > "../risuai-$TAURI_VERSION-1-$ARCH.pkg.tar.zst"
          cd ..
          
          echo "Created Arch Linux package: risuai-$TAURI_VERSION-1-$ARCH.pkg.tar.zst"
          ls -la "risuai-$TAURI_VERSION-1-$ARCH.pkg.tar.zst"
          
          # ì •ë¦¬
          rm -rf "$PKG_DIR"
          
      # ARM64 ê´€ë ¨ ì›ë³¸ íŒŒì¼ ë³µì›ì´ í•„ìš” ì—†ì–´ì¡Œìœ¼ë¯€ë¡œ ì œê±°ë¨
      - name: upload build artifacts (non-flatpak, non-android, non-ios)
        if: ${{ !matrix.settings.flatpak && !matrix.settings.android && !matrix.settings.ios }}
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.settings.platform }}-${{ contains(matrix.settings.args, 'aarch64') && 'aarch64' || (contains(matrix.settings.args, 'x86_64') && 'x86_64' || 'universal') }}
          path: |
            src-tauri/target/*/release/RisuAI*
            src-tauri/target/*/release/risuai*
            src-tauri/target/*/release/bundle/
            src-tauri/target/*/release/*.exe
            src-tauri/target/*/release/*.app
            src-tauri/target/*/release/*.msi
            src-tauri/target/*/release/*.dmg
            src-tauri/target/*/release/*.deb
            src-tauri/target/*/release/*.rpm
            ${{ !contains(matrix.settings.args, 'aarch64-unknown-linux-gnu') && 'src-tauri/target/*/release/*.AppImage' || '' }}
            src-tauri/target/*/release/*.sig
            src-tauri/target/*/release/*.json
            *.pkg.tar.zst
          if-no-files-found: warn
      - name: create flatpak binary archive
        if: startsWith(matrix.settings.platform, 'ubuntu') && !matrix.settings.android
        run: |
          echo "=== Creating Flatpak Binary Archive ==="
          
          # ì•„í‚¤í…ì²˜ë³„ ë°”ì´ë„ˆë¦¬ ê²½ë¡œ í™•ì¸
          if [[ "${{ matrix.settings.args }}" == *"aarch64-unknown-linux-gnu"* ]]; then
            TARGET_DIR="src-tauri/target/aarch64-unknown-linux-gnu/release"
            ARCH_SUFFIX="aarch64"
          else
            TARGET_DIR="src-tauri/target/x86_64-unknown-linux-gnu/release"
            ARCH_SUFFIX="x86_64"
          fi
          
          # ë°”ì´ë„ˆë¦¬ íŒŒì¼ í™•ì¸
          if [ -f "$TARGET_DIR/RisuAI" ]; then
            BINARY_NAME="RisuAI"
          elif [ -f "$TARGET_DIR/risuai" ]; then
            BINARY_NAME="risuai"
          else
            echo "No binary found in $TARGET_DIR"
            exit 1
          fi
          
          echo "Found binary: $TARGET_DIR/$BINARY_NAME"
          
          # Flatpakìš© ë°”ì´ë„ˆë¦¬ ì•„ì¹´ì´ë¸Œ ìƒì„±
          mkdir -p flatpak-binaries
          
          # ì„ì‹œ ë””ë ‰í† ë¦¬ì— í•„ìš”í•œ íŒŒì¼ë“¤ ë³µì‚¬
          mkdir -p temp-flatpak
          cp "$TARGET_DIR/$BINARY_NAME" temp-flatpak/RisuAI
          cp src-tauri/icons/128x128.png temp-flatpak/ 2>/dev/null || echo "128x128.png not found"
          cp src-tauri/icons/128x128@2x.png temp-flatpak/ 2>/dev/null || echo "128x128@2x.png not found"
          
          # ì•„ì¹´ì´ë¸Œ ìƒì„±
          tar -czf "flatpak-binaries/risuai-bin-${ARCH_SUFFIX}.tar.gz" -C temp-flatpak .
          
          # ì •ë¦¬
          rm -rf temp-flatpak
          
          echo "Created archive: flatpak-binaries/risuai-bin-${ARCH_SUFFIX}.tar.gz"
          tar -tzf "flatpak-binaries/risuai-bin-${ARCH_SUFFIX}.tar.gz"
      - name: upload flatpak binary archive
        if: startsWith(matrix.settings.platform, 'ubuntu') && !matrix.settings.android
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-binaries-${{ contains(matrix.settings.args, 'aarch64-unknown-linux-gnu') && 'aarch64' || 'x86_64' }}
          path: flatpak-binaries/
      - name: build android
        if: matrix.settings.android
        run: |
          pnpm tauri android init
          pnpm tauri android build
      - name: build ios
        if: matrix.settings.ios
        run: |
          pnpm tauri ios init
          pnpm tauri ios build
      - name: sign android apk
        if: matrix.settings.android
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "$KEYSTORE_FILE" | base64 -d > keystore.jks
          mkdir -p android-build
          for apk in $(find src-tauri/gen/android -name "*.apk"); do
            apk_name=$(basename "$apk" .apk)
            signed_apk="android-build/${apk_name}-signed.apk"
            BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools/ | sort -V | tail -n 1)
            APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"
            if [ -f "$APKSIGNER" ] && [ -x "$APKSIGNER" ]; then
              echo "Using apksigner: $APKSIGNER"
              $APKSIGNER sign \
                --ks keystore.jks \
                --ks-pass pass:"$KEYSTORE_PASSWORD" \
                --ks-key-alias "$KEY_ALIAS" \
                --key-pass pass:"$KEY_PASSWORD" \
                --out "$signed_apk" \
                "$apk"
            else
              echo "apksigner not found, falling back to jarsigner"
              jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
                -keystore keystore.jks \
                -storepass "$KEYSTORE_PASSWORD" \
                -keypass "$KEY_PASSWORD" \
                "$apk" "$KEY_ALIAS"
              if [ -f "$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign" ]; then
                $ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign -v 4 "$apk" "$signed_apk"
              else
                cp "$apk" "$signed_apk"
              fi
            fi
            echo "Signed APK: $signed_apk"
          done
          rm -f keystore.jks
          find src-tauri/gen/android -name "*.apk" -exec cp {} android-build/ \; || true
      - name: upload android artifacts
        if: matrix.settings.android
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android-build/
      - name: upload ios artifacts
        if: matrix.settings.ios
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: |
            src-tauri/gen/ios/**/*.ipa
            src-tauri/gen/ios/**/*.app
          if-no-files-found: warn
      - name: build flatpak (Linux AMD64 builds)
        if: startsWith(matrix.settings.platform, 'ubuntu') && !matrix.settings.android && !contains(matrix.settings.args, 'aarch64-unknown-linux-gnu')
        run: |
          echo "=== Building Flatpak for $FLATPAK_ARCH architecture using pre-built binaries ==="
          
          # ì•„í‚¤í…ì²˜ë³„ ë°”ì´ë„ˆë¦¬ ì•„ì¹´ì´ë¸Œ í™•ì¸
          ARCHIVE_NAME="risuai-bin-${FLATPAK_ARCH}.tar.gz"
          if [ ! -f "flatpak-binaries/$ARCHIVE_NAME" ]; then
            echo "Binary archive not found: flatpak-binaries/$ARCHIVE_NAME"
            exit 1
          fi
          
          # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ì•„ì¹´ì´ë¸Œë¥¼ ì ì ˆí•œ ìœ„ì¹˜ì— ë³µì‚¬
          cp "flatpak-binaries/$ARCHIVE_NAME" "risuai-bin.tar.gz"
          
          # ì•„í‚¤í…ì²˜ë³„ ë¹Œë“œ ë””ë ‰í† ë¦¬ ì„¤ì •
          BUILD_DIR="build-dir-$FLATPAK_ARCH"
          REPO_DIR="repo-$FLATPAK_ARCH"
          OUTPUT_NAME="risuai-$FLATPAK_ARCH.flatpak"
          
          # Flatpak ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ (ì•„í‚¤í…ì²˜ë³„)
          if [[ "$FLATPAK_ARCH" == "aarch64" ]]; then
            echo "Building ARM64 Flatpak using pre-built binaries..."
            flatpak-builder --force-clean --repo=$REPO_DIR --ccache --install-deps-from=flathub --arch=aarch64 $BUILD_DIR co.aiclient.risu.yml
          else
            echo "Building AMD64 Flatpak using pre-built binaries..."
            flatpak-builder --force-clean --repo=$REPO_DIR --ccache --install-deps-from=flathub $BUILD_DIR co.aiclient.risu.yml
          fi
          
          # ì €ì¥ì†Œ ìƒíƒœ í™•ì¸ ë° ë””ë²„ê¹…
          echo "=== Repository verification ==="
          echo "Repository directory: $REPO_DIR"
          echo "Output name: $OUTPUT_NAME"
          echo "Architecture: $FLATPAK_ARCH"
          
          # ì €ì¥ì†Œì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì•± ëª©ë¡ í™•ì¸
          flatpak --repo=$REPO_DIR list || echo "Failed to list repository contents"
          
          # ì €ì¥ì†Œì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ë¸Œëœì¹˜ í™•ì¸
          flatpak --repo=$REPO_DIR list --app --columns=name,branch,arch || echo "Failed to list app details"
          
          # ë²ˆë“¤ ìƒì„± (ë¸Œëœì¹˜ ë§¤ê°œë³€ìˆ˜ ì œê±° - ê¸°ë³¸ ë¸Œëœì¹˜ ì‚¬ìš©)
          echo "=== Creating Flatpak bundle ==="
          flatpak build-bundle $REPO_DIR $OUTPUT_NAME co.aiclient.risu
          
          # ì•„í‹°íŒ©íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± ë° íŒŒì¼ ì´ë™
          mkdir -p flatpak-build
          mv $OUTPUT_NAME flatpak-build/
          
          echo "Flatpak build completed: flatpak-build/$OUTPUT_NAME"
      - name: skip flatpak for ARM64 (due to GitHub Actions emulation limitations)
        if: startsWith(matrix.settings.platform, 'ubuntu') && !matrix.settings.android && contains(matrix.settings.args, 'aarch64-unknown-linux-gnu')
        run: |
          echo "=== ARM64 Flatpak Build Skipped ==="
          echo "ARM64 Flatpak build is disabled due to GitHub Actions ARM64 emulation limitations."
          echo "ARM64 users can use DEB or RPM packages instead."
          
          # ë¹ˆ flatpak-build ë””ë ‰í† ë¦¬ ìƒì„± (ì—…ë¡œë“œ ë‹¨ê³„ ì˜¤ë¥˜ ë°©ì§€)
          mkdir -p flatpak-build
          echo "ARM64 Flatpak build was skipped due to environment limitations." > flatpak-build/ARM64_FLATPAK_SKIPPED.txt
      - name: upload flatpak artifact
        if: startsWith(matrix.settings.platform, 'ubuntu') && !matrix.settings.android
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-${{ env.FLATPAK_ARCH }}
          path: flatpak-build/

  # New job to create a single pre-release with all build artifacts
  create-pre-release:
    needs: publish-tauri
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set release variables
        id: set_vars
        run: |
          TAURI_VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          BUILD_DATE=$(date +'%Y%m%d')
          BUILD_TIME=$(date +'%H%M%S')
          RELEASE_TAG="${TAURI_VERSION}-${BUILD_DATE}-${BUILD_TIME}"
          
          echo "TAURI_VERSION=$TAURI_VERSION" >> $GITHUB_ENV
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          
          echo "Generated release tag: $RELEASE_TAG"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Display downloaded artifacts
        run: |
          echo "=== Downloaded Artifacts Structure ==="
          find ./artifacts -type f -name "*" | sort
          
          echo ""
          echo "=== Detailed Artifact Summary ==="
          for dir in ./artifacts/*/; do
            if [ -d "$dir" ]; then
              echo "ğŸ“ Directory: $(basename "$dir")"
              file_count=$(find "$dir" -type f -name "*" | wc -l)
              echo "   Files: $file_count"
              
              # List specific file types
              echo "   ğŸ“¦ Package files:"
              find "$dir" -type f \( -name "*.dmg" -o -name "*.msi" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.flatpak" -o -name "*.apk" \) | while read -r file; do
                echo "     - $(basename "$file")"
              done
              
              # Check for any other notable files
              echo "   ğŸ“„ Other files:"
              find "$dir" -type f ! \( -name "*.dmg" -o -name "*.msi" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.flatpak" -o -name "*.apk" \) | while read -r file; do
                echo "     - $(basename "$file")"
              done | head -5  # Limit to first 5 to avoid spam
              
              echo ""
            fi
          done
          
          echo "=== Checking for ARM Flatpak specifically ==="
          if [ -d "./artifacts/flatpak-aarch64" ]; then
            echo "âœ… ARM64 Flatpak artifact directory found"
            find "./artifacts/flatpak-aarch64" -name "*.flatpak" | while read -r file; do
              echo "  ğŸ“¦ ARM64 Flatpak: $(basename "$file")"
            done
          else
            echo "âŒ ARM64 Flatpak artifact directory not found"
          fi
          
          if [ -d "./artifacts/flatpak-x86_64" ]; then
            echo "âœ… AMD64 Flatpak artifact directory found"
            find "./artifacts/flatpak-x86_64" -name "*.flatpak" | while read -r file; do
              echo "  ğŸ“¦ AMD64 Flatpak: $(basename "$file")"
            done
          else
            echo "âŒ AMD64 Flatpak artifact directory not found"
          fi
      
      - name: Organize release assets
        run: |
          echo "=== Organizing Release Assets ==="
          mkdir -p release-assets
          
          # Function to copy files with renamed pattern
          copy_and_rename() {
            local source_dir="$1"
            local arch_suffix="$2"
            local platform_name="$3"
            
            if [ -d "$source_dir" ]; then
              echo "Processing $source_dir for $platform_name ($arch_suffix)"
              
              # Copy various file types with architecture suffix
              # Also search in bundle subdirectories for .deb and .rpm files
              find "$source_dir" -type f \( -name "*.dmg" -o -name "*.msi" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.flatpak" -o -name "*.apk" -o -name "*.pkg.tar.zst" \) | while read -r file; do
                filename=$(basename "$file")
                extension="${filename##*.}"
                basename_no_ext="${filename%.*}"
                
                # Create new filename with architecture suffix
                new_filename="${basename_no_ext}-${arch_suffix}.${extension}"
                
                echo "  Copying: $filename -> $new_filename"
                cp "$file" "release-assets/$new_filename"
              done
              
              # Also check bundle directories specifically for Linux packages
              if [ -d "$source_dir/bundle" ]; then
                echo "  Checking bundle directory: $source_dir/bundle"
                find "$source_dir/bundle" -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" \) | while read -r file; do
                  filename=$(basename "$file")
                  extension="${filename##*.}"
                  basename_no_ext="${filename%.*}"
                  
                  # Create new filename with architecture suffix
                  new_filename="${basename_no_ext}-${arch_suffix}.${extension}"
                  
                  echo "  Copying from bundle: $filename -> $new_filename"
                  cp "$file" "release-assets/$new_filename"
                done
              fi
              
              # Recursively check all subdirectories for package files
              find "$source_dir" -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" \) -not -path "*/release-assets/*" | while read -r file; do
                # Skip if already processed
                if [[ "$file" != *"/release-assets/"* ]]; then
                  filename=$(basename "$file")
                  extension="${filename##*.}"
                  basename_no_ext="${filename%.*}"
                  
                  # Create new filename with architecture suffix
                  new_filename="${basename_no_ext}-${arch_suffix}.${extension}"
                  
                  # Only copy if not already exists
                  if [ ! -f "release-assets/$new_filename" ]; then
                    echo "  Copying from subdirectory: $filename -> $new_filename"
                    cp "$file" "release-assets/$new_filename"
                  fi
                fi
              done
            fi
          }
          
          # Process macOS builds
          copy_and_rename "./artifacts/build-macos-latest-aarch64" "macos-aarch64" "macOS ARM64"
          copy_and_rename "./artifacts/build-macos-latest-x86_64" "macos-x86_64" "macOS Intel"
          
          # Process Windows builds
          copy_and_rename "./artifacts/build-windows-latest-x86_64" "windows-x86_64" "Windows AMD64"
          copy_and_rename "./artifacts/build-windows-latest-aarch64" "windows-aarch64" "Windows ARM64"
          
          # Process Linux builds
          copy_and_rename "./artifacts/build-ubuntu-latest-x86_64" "linux-x86_64" "Linux AMD64"
          copy_and_rename "./artifacts/build-ubuntu-22.04-aarch64" "linux-aarch64" "Linux ARM64"
          
          # Process Flatpak builds
          copy_and_rename "./artifacts/flatpak-x86_64" "flatpak-x86_64" "Flatpak AMD64"
          copy_and_rename "./artifacts/flatpak-aarch64" "flatpak-aarch64" "Flatpak ARM64"
          
          # Process Android builds
          copy_and_rename "./artifacts/android-apk" "android" "Android"
          
          # iOS ë¹Œë“œëŠ” í˜„ì¬ ë¹„í™œì„±í™”ë¨
          # copy_and_rename "./artifacts/ios-ipa" "ios" "iOS"
          
          echo "=== Final Release Assets ==="
          echo "ğŸ“¦ Total files prepared for release: $(find release-assets/ -type f | wc -l)"
          echo ""
          echo "ğŸ“ Release assets by category:"
          
          # macOS files
          macos_files=$(find release-assets/ -name "*-macos-*" | wc -l)
          if [ $macos_files -gt 0 ]; then
            echo "ğŸ macOS ($macos_files files):"
            find release-assets/ -name "*-macos-*" -exec basename {} \; | sort | sed 's/^/   - /'
          fi
          
          # Windows files  
          windows_files=$(find release-assets/ -name "*-windows-*" | wc -l)
          if [ $windows_files -gt 0 ]; then
            echo "ğŸªŸ Windows ($windows_files files):"
            find release-assets/ -name "*-windows-*" -exec basename {} \; | sort | sed 's/^/   - /'
          fi
          
          # Linux files (excluding flatpak)
          linux_files=$(find release-assets/ -name "*-linux-*" ! -name "*flatpak*" | wc -l)
          if [ $linux_files -gt 0 ]; then
            echo "ğŸ§ Linux packages ($linux_files files):"
            find release-assets/ -name "*-linux-*" ! -name "*flatpak*" -exec basename {} \; | sort | sed 's/^/   - /'
          fi
          
          # Flatpak files
          flatpak_files=$(find release-assets/ -name "*flatpak*" | wc -l)
          if [ $flatpak_files -gt 0 ]; then
            echo "ğŸ“¦ Flatpak ($flatpak_files files):"
            find release-assets/ -name "*flatpak*" -exec basename {} \; | sort | sed 's/^/   - /'
          fi
          
          # Android files
          android_files=$(find release-assets/ -name "*-android*" | wc -l)
          if [ $android_files -gt 0 ]; then
            echo "ğŸ¤– Android ($android_files files):"
            find release-assets/ -name "*-android*" -exec basename {} \; | sort | sed 's/^/   - /'
          fi
          
          echo ""
          echo "ğŸ“‹ Complete file list:"
          ls -la release-assets/ | grep -v "^total" | grep -v "^d" | awk '{print "   ğŸ“„ " $9 " (" $5 " bytes)"}'
      
      - name: Create Tauri updater latest.json
        run: |
          echo "=== Creating Tauri Updater latest.json ==="
          
          # ë¦´ë¦¬ìŠ¤ URL ë² ì´ìŠ¤ (GitHub ë¦´ë¦¬ìŠ¤ í˜ì´ì§€)
          RELEASE_URL_BASE="https://github.com/kwaroran/RisuAI/releases/download/${{ env.RELEASE_TAG }}"
          
          # latest.json ê¸°ë³¸ êµ¬ì¡° ìƒì„±
          cat > latest.json << EOF
          {
            "version": "${{ env.TAURI_VERSION }}",
            "notes": "Release of v${{ env.TAURI_VERSION }}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "platforms": {}
          }
          EOF
          
          # ê° í”Œë«í¼ë³„ signatureì™€ URLì„ ìˆ˜ì§‘í•˜ì—¬ JSONì— ì¶”ê°€
          declare -A platform_mapping=(
            ["darwin-aarch64"]="macos-aarch64"
            ["darwin-x86_64"]="macos-x86_64"
            ["windows-x86_64"]="windows-x86_64"
            ["windows-aarch64"]="windows-aarch64"
            ["linux-x86_64"]="linux-x86_64"
            ["linux-aarch64"]="linux-aarch64"
          )
          
          # í”Œë«í¼ë³„ íŒŒì¼ ì°¾ê¸° ë° JSON ì—…ë°ì´íŠ¸
          for platform_key in "${!platform_mapping[@]}"; do
            arch_suffix="${platform_mapping[$platform_key]}"
            echo "Processing platform: $platform_key -> $arch_suffix"
            
            # í•´ë‹¹ í”Œë«í¼ì˜ signature íŒŒì¼ ì°¾ê¸°
            sig_file=""
            main_file=""
            
            case "$platform_key" in
              "darwin-aarch64"|"darwin-x86_64")
                # macOSì˜ ê²½ìš° .dmg íŒŒì¼ê³¼ í•´ë‹¹ .sig íŒŒì¼
                main_file=$(find release-assets/ -name "*-${arch_suffix}.dmg" | head -1)
                if [ -n "$main_file" ]; then
                  sig_file=$(find ./artifacts/ -name "$(basename "$main_file").sig" 2>/dev/null | head -1)
                fi
                ;;
              "windows-x86_64"|"windows-aarch64")
                # Windowsì˜ ê²½ìš° .msi íŒŒì¼ê³¼ í•´ë‹¹ .sig íŒŒì¼
                main_file=$(find release-assets/ -name "*-${arch_suffix}.msi" | head -1)
                if [ -n "$main_file" ]; then
                  sig_file=$(find ./artifacts/ -name "$(basename "$main_file").sig" 2>/dev/null | head -1)
                fi
                ;;
              "linux-x86_64")
                # Linux AMD64ì˜ ê²½ìš° AppImage íŒŒì¼ê³¼ í•´ë‹¹ .sig íŒŒì¼
                main_file=$(find release-assets/ -name "*-${arch_suffix}.AppImage" | head -1)
                if [ -n "$main_file" ]; then
                  sig_file=$(find ./artifacts/ -name "$(basename "$main_file").sig" 2>/dev/null | head -1)
                fi
                ;;
              "linux-aarch64")
                # Linux ARM64ì˜ ê²½ìš° AppImageê°€ ì—†ìœ¼ë¯€ë¡œ DEB íŒŒì¼ ì‚¬ìš©
                main_file=$(find release-assets/ -name "*-${arch_suffix}.deb" | head -1)
                if [ -n "$main_file" ]; then
                  sig_file=$(find ./artifacts/ -name "$(basename "$main_file").sig" 2>/dev/null | head -1)
                fi
                ;;
            esac
            
            if [ -n "$main_file" ] && [ -f "$main_file" ]; then
              filename=$(basename "$main_file")
              file_url="${RELEASE_URL_BASE}/${filename}"
              
              # signature ì½ê¸° (íŒŒì¼ì´ ìˆëŠ” ê²½ìš°)
              signature=""
              if [ -n "$sig_file" ] && [ -f "$sig_file" ]; then
                signature=$(cat "$sig_file" | tr -d '\n\r')
                echo "Found signature for $platform_key: ${sig_file}"
              else
                echo "âš ï¸  No signature file found for $platform_key ($filename)"
                signature="WARNING: No signature available"
              fi
              
              # JSONì— í”Œë«í¼ ì •ë³´ ì¶”ê°€ (jq ì‚¬ìš©)
              jq --arg platform "$platform_key" \
                 --arg signature "$signature" \
                 --arg url "$file_url" \
                 '.platforms[$platform] = {"signature": $signature, "url": $url}' \
                 latest.json > latest.json.tmp && mv latest.json.tmp latest.json
              
              echo "âœ… Added $platform_key: $filename"
            else
              echo "âŒ No main file found for platform $platform_key with suffix $arch_suffix"
            fi
          done
          
          # latest.jsonì„ release-assetsì— ë³µì‚¬ (.sig íŒŒì¼ë“¤ë„ í•¨ê»˜)
          cp latest.json release-assets/
          
          # .sig íŒŒì¼ë“¤ì„ release-assetsì— ë³µì‚¬
          echo "=== Copying .sig files to release assets ==="
          find ./artifacts/ -name "*.sig" | while read -r sig_file; do
            if [ -f "$sig_file" ]; then
              cp "$sig_file" release-assets/
              echo "Copied signature: $(basename "$sig_file")"
            fi
          done
          
          echo "=== Generated latest.json content ==="
          cat latest.json | jq '.'
          
          echo "=== Verifying latest.json structure ==="
          platforms_count=$(jq '.platforms | keys | length' latest.json)
          echo "Platforms included: $platforms_count"
          jq -r '.platforms | keys[]' latest.json | while read platform; do
            has_signature=$(jq -r ".platforms[\"$platform\"].signature" latest.json)
            has_url=$(jq -r ".platforms[\"$platform\"].url" latest.json)
            echo "  - $platform: signature=$([ ${#has_signature} -gt 20 ] && echo "âœ…" || echo "âŒ"), url=$([ -n "$has_url" ] && echo "âœ…" || echo "âŒ")"
          done
      
      - name: Create pre-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: 'RisuAI ${{ env.RELEASE_TAG }}'
          body: |
            # RisuAI Pre-release Build
            
            **Version:** ${{ env.TAURI_VERSION }}  
            **Build Date:** ${{ env.BUILD_DATE }}  
            **Build Time:** ${{ env.BUILD_TIME }}  
            
            This is an automated pre-release build containing binaries for all supported platforms and architectures.
            
            ## Supported Platforms
            
            ### Desktop Applications
            - **macOS**: ARM64 (Apple Silicon) and Intel (x86_64) - DMG installers
            - **Windows**: x86_64 and ARM64 - MSI installers
            - **Linux**: AMD64 (x86_64) and ARM64 (aarch64) - Multiple formats available
            
            ### Linux Package Formats
            - **AppImage**: Portable Linux application format (x86_64 and aarch64)
            - **DEB**: Debian/Ubuntu package format (x86_64 and aarch64)
            - **RPM**: Red Hat/Fedora package format (x86_64 and aarch64)
            - **PKG.TAR.ZST**: Arch Linux package format (x86_64 and aarch64)
            - **Flatpak**: Universal Linux packaging format (x86_64 and aarch64)
            
            ### Mobile
            - **Android**: APK files (signed and unsigned)
            <!-- iOS ë¹Œë“œëŠ” í˜„ì¬ ê°œë°œì ê³„ì • ì—†ìŒìœ¼ë¡œ ì¸í•´ ë¹„í™œì„±í™”ë¨ -->
            <!-- - **iOS**: IPA files for App Store distribution and .app bundles for development -->
            
            ## Installation Notes
            
            ### macOS
            - Download the appropriate DMG file for your architecture
            - `-macos-aarch64.dmg`: For Apple Silicon Macs (M1, M2, M3, etc.)
            - `-macos-x86_64.dmg`: For Intel Macs
            
            ### Windows
            - Download the MSI installer: `-windows-x86_64.msi`
            
            ### Linux
            Choose the format that works best for your distribution:
            - **AppImage** (Recommended for most users): Download, make executable, and run
            - **DEB packages**: For Debian, Ubuntu, and derivatives - `sudo dpkg -i filename.deb`
            - **RPM packages**: For Red Hat, Fedora, SUSE, and derivatives - `sudo rpm -i filename.rpm`
            - **PKG.TAR.ZST packages**: For Arch Linux and derivatives - `sudo pacman -U filename.pkg.tar.zst`
            - **Flatpak**: Universal format - `flatpak install filename.flatpak`
            
            ### Android
            - Download the APK file: `-android.apk`
            - Enable "Unknown sources" in Android settings if needed
            - Signed APKs are provided for secure installation
            
            <!-- iOSëŠ” í˜„ì¬ ê°œë°œì ê³„ì • ì—†ìŒìœ¼ë¡œ ì¸í•´ ë¹„í™œì„±í™”ë¨
            ### iOS
            - Download the IPA file: `-ios.ipa`
            - Install via Xcode, TestFlight, or enterprise distribution
            - .app bundles are available for development/testing purposes
            -->
            
            ## File Naming Convention
            
            Files are named with architecture suffixes for easy identification:
            - `-macos-aarch64`: macOS Apple Silicon (ARM64)
            - `-macos-x86_64`: macOS Intel (x86_64)
            - `-windows-x86_64`: Windows 64-bit (Intel/AMD)
            - `-windows-aarch64`: Windows ARM64
            - `-linux-x86_64`: Linux AMD64
            - `-linux-aarch64`: Linux ARM64 (Raspberry Pi, ARM servers, etc.)
            - `-flatpak-x86_64`: Flatpak for AMD64 systems
            - `-flatpak-aarch64`: Flatpak for ARM64 systems
            - `-android`: Android APK
            <!-- iOSëŠ” í˜„ì¬ ë¹„í™œì„±í™”ë¨: - `-ios`: iOS IPA/APP bundle -->
            
            ## Architecture Support Summary
            
            | Platform | x86_64/AMD64 | ARM64/aarch64 |
            |----------|--------------|---------------|
            | macOS    | âœ… DMG       | âœ… DMG        |
            | Windows  | âœ… MSI       | âœ… MSI        |
            | Linux    | âœ… DEB/RPM/PKG.TAR.ZST/AppImage/Flatpak | âœ… DEB/RPM/PKG.TAR.ZST* |
            | Android  | âœ… APK       | âœ… APK        |
            
            *ARM64 Linux does not provide AppImage and Flatpak due to GitHub Actions environment limitations. Please use DEB, RPM, or PKG.TAR.ZST packages instead.
            <!-- iOSëŠ” í˜„ì¬ ê°œë°œì ê³„ì • ì—†ìŒìœ¼ë¡œ ì¸í•´ ë¹„í™œì„±í™”ë¨
            | iOS      | âœ… IPA/APP   | âœ… IPA/APP    |
            -->
          draft: false
          prerelease: true
          files: release-assets/*
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up artifacts
        if: always()
        run: |
          echo "=== Cleaning up temporary files ==="
          rm -rf ./artifacts
          rm -rf ./release-assets
          echo "Cleanup completed"
